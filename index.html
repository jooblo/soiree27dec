<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secret Santa 27 D√©c</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Playfair+Display:ital,wght@1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --gold: #d4af37;
            --gold-glow: rgba(212, 175, 55, 0.3);
            --bg: #050505;
            --card: rgba(20, 20, 20, 0.95);
            --text: #ffffff;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg);
            background-image: radial-gradient(circle at top, #1a1a1a, #000);
            color: var(--text);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%; max-width: 500px;
            background: var(--card);
            border: 1px solid #333;
            border-radius: 24px;
            padding: 30px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
        }

        h1 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            text-align: center; margin: 0 0 10px 0;
            font-size: 2rem;
        }
        
        .subtitle { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 30px; }

        .input-group { margin-bottom: 15px; }
        label { display: block; color: var(--gold); font-size: 0.8rem; margin-bottom: 5px; margin-left: 5px; }
        
        input {
            width: 100%; padding: 16px;
            background: #111; border: 1px solid #333;
            color: white; border-radius: 12px;
            font-family: inherit; font-size: 1rem;
            transition: 0.3s; box-sizing: border-box;
        }
        input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 15px var(--gold-glow); }

        button {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-weight: 800; font-size: 1rem; cursor: pointer;
            text-transform: uppercase; margin-top: 10px;
            transition: transform 0.2s;
        }
        button:active { transform: scale(0.98); }

        .btn-gold { background: linear-gradient(135deg, #d4af37, #aa8c2c); color: #000; }
        .btn-admin { background: #222; color: #ccc; border: 1px solid #444; margin-top: 30px; font-size: 0.8rem; padding: 12px; }

        #list { margin-top: 30px; border-top: 1px solid #333; padding-top: 20px; }
        .participant-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
            animation: fadeIn 0.5s ease;
        }
        .tag-group { font-size: 0.7rem; background: #333; color: #aaa; padding: 2px 8px; border-radius: 6px; margin-left: 8px; }

        .result-card {
            background: #222; border: 1px solid #444; padding: 20px; border-radius: 16px; margin-bottom: 15px; text-align: center;
        }
        .whatsapp-btn {
            background: #25D366; color: white; display: flex; justify-content: center; align-items: center; gap: 10px;
            text-decoration: none; padding: 12px; border-radius: 10px; font-weight: bold; margin-top: 10px;
        }

        .hidden { display: none; }
        .loading { color: #888; font-style: italic; text-align: center; margin-top: 20px; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>

<div class="container">
    <h1>Soir√©e 27 D√©cembre</h1>
    <p class="subtitle">Espace Secret Santa</p>

    <div id="view-signup">
        <div class="input-group">
            <label>Ton Pr√©nom</label>
            <input type="text" id="inpName" placeholder="Ex: Laura">
        </div>
        <div class="input-group">
            <label>Ton Groupe (Optionnel)</label>
            <input type="text" id="inpGroup" placeholder="Ex: Couple A">
            <div style="font-size:0.7rem; color:#666; margin-top:5px; margin-left:5px;">
                Mets le m√™me nom de groupe que ton conjoint(e) pour ne pas tomber sur lui/elle.
            </div>
        </div>
        
        <button class="btn-gold" onclick="register()">Je participe !</button>
        <p id="msg-status" style="text-align:center; margin-top:15px; color:var(--gold);"></p>
    </div>

    <div id="list">
        <div style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:#666; margin-bottom:10px;">
            Participants inscrits (<span id="count">0</span>)
        </div>
        <div id="participants-container"></div>
        <div id="loader" class="loading">Chargement...</div>
    </div>

    <div id="view-admin" class="hidden">
        <div style="height:1px; background:#333; margin:30px 0;"></div>
        <h3 style="color:var(--gold); text-align:center;">Zone Organisateur</h3>
        <p style="text-align:center; font-size:0.8rem; color:#888;">
            Attends que tout le monde soit inscrit, puis lance le tirage.
        </p>
        <button class="btn-gold" onclick="launchDraw()">üé≤ LANCER LE TIRAGE</button>
        <p id="draw-error" style="color:#ff5555; text-align:center; display:none; margin-top:10px;"></p>
        <div id="results-area" style="margin-top:20px;"></div>
    </div>

    <div id="admin-link-area" style="text-align:center; margin-top:40px;">
        <span style="font-size:0.7rem; color:#444; cursor:pointer; text-decoration:underline;" onclick="becomeAdmin()">
            Je suis l'organisateur
        </span>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://trhdwabtdkbzqadqznvq.supabase.co"; 
    const SUPABASE_KEY = "sb_publishable_nbE57FWx6IYsRW7Qh_a8zA_Afwp4p4Y";
    
    // Initialisation avec un nom de variable unique (sbClient) pour √©viter les conflits
    const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const params = new URLSearchParams(location.search);
    const EVENT_ID = params.get('event') || 'soiree27'; 
    
    window.onload = function() {
        fetchParticipants();
        setInterval(fetchParticipants, 5000);

        if(params.get('admin') === 'true') {
            document.getElementById('view-admin').classList.remove('hidden');
            document.getElementById('admin-link-area').classList.add('hidden');
            document.getElementById('view-signup').classList.add('hidden');
        }
    };

    async function register() {
        const name = document.getElementById('inpName').value.trim();
        const group = document.getElementById('inpGroup').value.trim();

        if(!name) return alert("Indique ton pr√©nom !");
        document.getElementById('msg-status').innerText = "Envoi...";

        // Utilisation de sbClient (et non supabase)
        const { error } = await sbClient.from('participants').insert([
            { event_id: EVENT_ID, name: name, group_label: group || null }
        ]);

        if(error) {
            alert("Erreur Inscription : " + error.message);
            document.getElementById('msg-status').innerText = "";
        } else {
            document.getElementById('msg-status').innerText = "‚úÖ Inscrit !";
            document.getElementById('inpName').value = "";
            document.getElementById('inpGroup').value = "";
            fetchParticipants();
        }
    }

    async function fetchParticipants() {
        // Utilisation de sbClient
        const { data, error } = await sbClient
            .from('participants')
            .select('*')
            .eq('event_id', EVENT_ID)
            .order('created_at', { ascending: true });

        if(error) {
            document.getElementById('loader').innerText = "ERREUR BDD : " + error.message;
            document.getElementById('loader').style.color = "red";
            console.error(error);
        } else if(data) {
            document.getElementById('loader').classList.add('hidden');
            renderList(data);
        }
    }

    function renderList(participants) {
        const container = document.getElementById('participants-container');
        document.getElementById('count').innerText = participants.length;
        container.innerHTML = '';

        participants.forEach(p => {
            const div = document.createElement('div');
            div.className = 'participant-row';
            div.innerHTML = `<span style="font-weight:600;">${p.name}</span>${p.group_label ? `<span class="tag-group">${p.group_label}</span>` : ''}`;
            container.appendChild(div);
        });
        window.currentParticipants = participants;
    }

    function becomeAdmin() {
        if(confirm("Passer en mode organisateur ?")) {
            const url = new URL(window.location);
            url.searchParams.set('admin', 'true');
            window.history.pushState({}, '', url);
            location.reload();
        }
    }

    function launchDraw() {
        const parts = window.currentParticipants || [];
        if(parts.length < 2) return alert("Pas assez de participants !");

        let givers = [], receivers = [];
        let success = false;

        for(let k=0; k<2000; k++) {
            givers = [...parts];
            receivers = [...parts].sort(() => Math.random() - 0.5);
            let valid = true;
            for(let i=0; i<givers.length; i++) {
                const g = givers[i]; const r = receivers[i];
                if(g.id === r.id) { valid = false; break; }
                if(g.group_label && r.group_label && g.group_label.toLowerCase() === r.group_label.toLowerCase()) { valid = false; break; }
            }
            if(valid) { success = true; break; }
        }

        if(!success) {
            const err = document.getElementById('draw-error');
            err.style.display = 'block';
            err.innerText = "Tirage impossible : Trop de contraintes.";
            return;
        }
        displayResults(givers, receivers);
    }

    function displayResults(givers, receivers) {
        document.getElementById('draw-error').style.display = 'none';
        const area = document.getElementById('results-area');
        area.innerHTML = '';

        givers.forEach((g, i) => {
            const r = receivers[i];
            const spoilerSpace = "\u200B".repeat(600); 
            const msg = `üéÑ SECRET SANTA !\n\nCoucou ${g.name}, pour la soir√©e du 27 d√©c :\n\nTu dois offrir un cadeau (20-30‚Ç¨) √†...${spoilerSpace}\n\nüëá (Clique sur Lire la suite)\n\nüéÅ ${r.name} üéÅ\n\nü§´ Chut !`;
            const link = `https://wa.me/?text=${encodeURIComponent(msg)}`;

            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <div style="color:#888; font-size:0.8rem;">Pour</div>
                <div style="font-size:1.5rem; color:var(--gold); margin-bottom:10px;">${g.name}</div>
                <div style="font-size:0.8rem;">(Cible : ${r.name})</div>
                <a href="${link}" class="whatsapp-btn" target="_blank">üöÄ Envoyer √† ${g.name}</a>
            `;
            area.appendChild(card);
        });
    }
</script>

</body>
</html>